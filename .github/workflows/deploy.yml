name: ðŸš€ Deploy ProduÃ§Ã£o

on:
  push:
    branches: [main, master]
    tags: ['v*']
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente para deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ========================================
  # BUILD & PUSH IMAGES
  # ========================================
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ðŸ”‘ Login GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ðŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: ðŸ—ï¸ Build & Push Web
        uses: docker/build-push-action@v5
        with:
          context: ./apps/web
          file: ./apps/web/Dockerfile.prod
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/web:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/web:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
      - name: ðŸ—ï¸ Build & Push API
        uses: docker/build-push-action@v5
        with:
          context: ./apps/api
          file: ./apps/api/Dockerfile.prod
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/api:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/api:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
      - name: ðŸ—ï¸ Build & Push Worker
        uses: docker/build-push-action@v5
        with:
          context: ./apps/worker
          file: ./apps/worker/Dockerfile.prod
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/worker:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/worker:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ========================================
  # DEPLOY PRODUÃ‡ÃƒO
  # ========================================
  deploy-production:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/')
    environment: production
    
    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: ðŸ”‘ Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          
      - name: ðŸ” Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
          
      - name: ðŸš€ Deploy no VPS
        run: |
          # Atualizar .env.production no servidor
          scp env.production.example ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/opt/atendechat/.env.production
          
          # Executar deploy via SSH
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            cd /opt/atendechat
            
            # Backup do .env atual
            if [ -f .env.production ]; then
              cp .env.production .env.production.backup.$(date +%Y%m%d_%H%M%S)
            fi
            
            # Atualizar .env.production
            cp env.production.example .env.production
            
            # Fazer login no GHCR
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # Pull das novas imagens
            docker compose -f compose.prod.yml pull
            
            # Rolling update sem downtime
            docker compose -f compose.prod.yml up -d --no-deps --scale api=2 --scale worker=2
            
            # Aguardar health checks
            sleep 30
            
            # Verificar saÃºde dos serviÃ§os
            docker compose -f compose.prod.yml ps
            
            # Remover containers antigos
            docker compose -f compose.prod.yml up -d
            
            # Limpar imagens nÃ£o utilizadas
            docker image prune -f
            
            echo "âœ… Deploy concluÃ­do com sucesso!"
          EOF
          
      - name: ðŸ” Verificar deploy
        run: |
          # Aguardar um pouco para estabilizaÃ§Ã£o
          sleep 60
          
          # Verificar endpoints principais
          curl -f https://api.seudominio.com/api/v1/health || exit 1
          curl -f https://app.seudominio.com/api/health || exit 1
          
      - name: ðŸ“Š Notificar sucesso
        if: success()
        run: |
          echo "ðŸŽ‰ Deploy em produÃ§Ã£o concluÃ­do com sucesso!"
          echo "ðŸŒ Frontend: https://app.seudominio.com"
          echo "ðŸ”Œ API: https://api.seudominio.com"
          echo "ðŸ“ˆ MÃ©tricas: https://prometheus.seudominio.com"
          echo "ðŸ“Š Grafana: https://grafana.seudominio.com"
          
      - name: ðŸš¨ Notificar falha
        if: failure()
        run: |
          echo "âŒ Deploy em produÃ§Ã£o falhou!"
          echo "ðŸ” Verificar logs no VPS:"
          echo "ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}"
          echo "cd /opt/atendechat && docker compose -f compose.prod.yml logs"

  # ========================================
  # ROLLBACK (se necessÃ¡rio)
  # ========================================
  rollback:
    needs: deploy-production
    runs-on: ubuntu-latest
    if: failure()
    environment: production
    
    steps:
      - name: ðŸ”‘ Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          
      - name: ðŸ” Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
          
      - name: ðŸ”„ Executar rollback
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            cd /opt/atendechat
            
            echo "ðŸ”„ Executando rollback..."
            
            # Restaurar .env anterior
            if [ -f .env.production.backup.* ]; then
              LATEST_BACKUP=$(ls -t .env.production.backup.* | head -1)
              cp "$LATEST_BACKUP" .env.production
              echo "âœ… .env.production restaurado de $LATEST_BACKUP"
            fi
            
            # Restart dos serviÃ§os
            docker compose -f compose.prod.yml restart
            
            # Verificar saÃºde
            sleep 30
            docker compose -f compose.prod.yml ps
            
            echo "âœ… Rollback concluÃ­do!"
          EOF
          
      - name: ðŸ“¢ Notificar rollback
        run: |
          echo "ðŸ”„ Rollback executado automaticamente devido a falha no deploy"
          echo "ðŸ” Verificar logs e investigar problema"
